<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulateur d'improvisation</title>
  <meta name="description" content="Évaluer et développer rapidement votre niveau en prise de parole en public avec le simulateur d'improvisation Letmotiv.">

  <!-- Polices + FontAwesome -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans&family=Montserrat:wght@700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />

  <style>
    /* --- GLOBAL --- */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'DM Sans', sans-serif;
      background-color: #ffffff;
      color: #333333;
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: 60px; /* Laisser place au header fixe */
      padding-bottom: 20px; 
    }

    /* HEADER */
    .header {
      background-color: #182d84;
      color: #FFFFFF;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 100;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      height: 60px;
    }
    .header-l2 {
      font-size: 14px;
    }

    /* Barre de progression */
    .progress-container {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba(24, 45, 132, 0.1);
      z-index: 99;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background-color: #00a48a;
      transition: width 0.5s ease;
    }

    /* Intro box */
    .intro-box {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, #182d84, #00a48a);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #ffffff;
      z-index: 999;
      animation: fadeIn 0.8s forwards;
    }
    .intro-box h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.5rem;
      margin-bottom: 30px;
    }
    .intro-box button {
      background-color: #ffffff;
      color: #182d84;
      font-family: 'DM Sans', sans-serif;
      font-size: 1.2rem;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s, color 0.3s;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    }
    .intro-box button:hover {
      background-color: #00a48a;
      color: #ffffff;
      transform: scale(1.05);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to   { opacity: 0; }
    }
    @keyframes slideDown {
      0% {
        transform: translateY(-100%);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes slideUp {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      100% {
        transform: translateY(100%);
        opacity: 0;
      }
    }

    /* Container absolu pour les boxes */
    .box-container {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      min-height: 500px; /* Ajustez selon vos besoins */
    }

    /* BOXES en absolu => superposition */
    .box {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      background-color: #E2E7E3;
      border: 2px solid #eee;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
      opacity: 0;
      display: none; 
    }
    .box.active {
      display: flex; /* Changer en flex pour le centrage dans box1 */
      opacity: 1; /* Rendre la boîte visible */
      transform: translateY(0); /* Réinitialiser la transformation */
    }

    /* Animations “scroll-like” */
    .slide-in-down {
      animation: slideDown 0.6s forwards ease;
    }
    .slide-out-up {
      animation: slideUp 0.6s forwards ease;
    }

    /* box-header */
    .box-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .box-title {
      font-size: 18px;
      font-weight: bold;
      color: #182d84;
      text-align: center;
      flex-grow: 1;
    }
    .step-indicator {
      width: 40px; height: 40px;
      background-color: #182d84;
      color: #FFFFFF;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    /* Bouton flèche “haut” */
    .back-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background-color: #808080;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s, transform 0.3s;
    }
    .back-btn:hover {
      background-color: #505050;
      transform: scale(1.05);
    }
    .back-btn:active {
      background-color: #303030;
    }
    .back-btn.hidden-visibility {
      visibility: hidden;
    }

    /* Bouton flèche “bas” (next-btn), 100% centré */
    .next-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #182d84;
      background-color: transparent;
      color: #182d84;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      display: flex;           /* pour centrer l'icône */
      align-items: center;     /* vertical */
      justify-content: center; /* horizontal */
      margin: 10px auto;       /* centre le bouton dans la box */
      transition: background-color 0.3s, color 0.3s, transform 0.3s;
    }
    .next-btn:hover {
      background-color: #00a48a;
      color: #ffffff;
      transform: scale(1.05);
    }

    /* Erreur */
    .error-message {
      color: red;
      margin-top: 10px;
      font-weight: bold;
      display: none; 
      text-align: center; 
      width: 100%;
    }

    /* Explanation box */
    .explanation-box {
      visibility: hidden;    
      opacity: 0;
      transform: translateY(-10px);
      margin-top: 0;
      background-color: #fefefe;
      border: 0 solid #ccc;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      font-style: italic;
      color: #333;
      transition: border 0.5s ease, opacity 0.5s ease, transform 0.5s ease;
    }
    .explanation-box.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
      border: 2px solid #ccc;
    }

    .objectives-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .objectives-container button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background-color: #ffffff;
      color: #182d84;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    .objectives-container button:hover {
      background-color: #00a48a;
      color: #ffffff;
    }
    .selected-objective {
      background-color: #00a48a !important;
      color: #ffffff;
    }

    /* BOX2 (vidéo) */
    .subject-wrapper {
      margin-top: 10px;
      background-color: #fefefe;
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      font-style: italic;
      color: #333;
      display: none; 
    }
    .video-box {
      margin: 10px auto;
      border: 3px solid #182d84;
      border-radius: 6px;
      max-width: 500px;
      background-color: #fefefe;
      height: 300px;
      position: relative;
      display: flex;
      justify-content: center; 
      align-items: center;     
      overflow: hidden;
    }
    .video-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    .video-text {
      position: absolute;
      z-index: 2;
      color: #555;
      font-style: italic;
      font-size: 14px;
      text-align: center;
      padding: 20px;
      pointer-events: none;
    }
    .recording-indicator {
      position: absolute;
      top: 10px; right: 10px;
      display: none;
      align-items: center;
      background-color: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
      color: #ff0000;
      z-index: 3;
    }
    .recording-indicator .dot {
      height: 10px; width: 10px;
      background-color: #ff0000;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    .countdown {
      position: absolute;
      bottom: 10px; right: 10px;
      font-size: 24px;
      color: #ffffff;
      display: none;
      z-index: 4;
      background-color: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
      text-align: center;
    }
    .initial-countdown-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(128, 128, 128, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
      border-radius: 6px;
    }
    .initial-countdown {
      font-size: 48px;
      color: #ffffff;
      font-weight: bold;
    }
    .impro-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center; 
      margin-top: 10px;
    }
    .hidden-btn { display: none; }

    /* BOX4 (3e étape) */
    .linkedin-share-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: #0e76a8;
      color: #FFFFFF;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.3s;
      cursor: pointer;
      margin: 5px;
      gap: 10px;
    }
    .linkedin-share-button:hover,
    .linkedin-share-button:active {
      background-color: #085a8c;
      transform: translateY(-3px);
    }
    .progression-buttons {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .progression-buttons p {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
    }

    /* BOX3 (4e étape) */
    .download-section {
      text-align: left;
      margin-bottom: 20px;
    }
    .download-section h3 {
      text-align: center; /* Centrer le texte */
      font-size: 14px; /* Ajuster la taille de la police */
      font-weight: normal; /* Pas en gras */
      margin-bottom: 20px; /* Ajouter un peu d'espace en dessous */
    }
    .download-buttons {
      margin-top: 20px;
      background-color: #fefefe;
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
      display: none; 
      text-align: center;
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .download-buttons.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 48%;
    }
    .input-group label {
      margin-bottom: 5px;
      font-weight: bold;
      color: #000;
    }
    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    .input-group input:focus {
      border-color: #00a48a;
      outline: none;
    }
    .download-fields {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 15px;
    }

    /* Boutons “généraux” (Valider, etc.) */
    button,
    a.btn {
      background-color: #182d84;
      color: #FFFFFF;
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      cursor: pointer;
      margin: 5px;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    button:hover,
    button:active,
    a.btn:hover,
    a.btn:active {
      background-color: #00a48a;
      transform: translateY(-3px);
    }
  </style>
</head>
<body>

  <!-- Intro box -->
  <div class="intro-box" id="intro-box">
    <h1>Entraîne-toi à la prise de parole</h1>
    <button id="start-intro-btn" aria-label="Commencer">Commencer</button>
  </div>

  <!-- HEADER -->
  <div class="header">
    <div class="header-l1">Simulateur d'improvisation en public</div>
    <div class="header-l2">by Letmotiv</div>
  </div>

  <div class="progress-container">
    <div class="progress-bar" id="top-progress-bar"></div>
  </div>

  <!-- Container absolu pour toutes les boxes -->
  <div class="box-container" id="box-container" style="height: 700px;">
    <!-- BOX1 -->
    <div class="box" id="box1">
      <div class="box-header">
        <button class="back-btn hidden-visibility" aria-label="Retour" id="back-btn1">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Choisis ton objectif</div>
        <div class="step-indicator">1/4</div>
      </div>

      <div class="objectives-container">
        <button data-category="convaincre">Convaincre</button>
        <button data-category="inspirer">Inspirer</button>
        <button data-category="lacher-prise">Lâcher prise</button>
        <button data-category="toast">Porter un toast</button>
        <button data-category="repartie">Avoir de la répartie</button>
        <button data-category="vendre">Vendre</button>
        <button data-category="conflit">Gérer un conflit</button>
        <button data-category="diction">Diction</button>
      </div>

      <div id="objective-error" class="error-message">
        Sélectionne un objectif avant de continuer.
      </div>
      <div class="explanation-box" id="explanation-box"></div>

      <!-- Flèche bas -->
      <button class="next-btn" id="next-btn1" aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- BOX2 -->
    <div class="box" id="box2">
      <div class="box-header">
        <button class="back-btn" id="back-btn2" aria-label="Retour box1">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Lance ton improvisation</div>
        <div class="step-indicator">2/4</div>
      </div>

      <button id="generate-subject-btn">Générer un sujet aléatoire</button>
      <div id="subject-wrapper" class="subject-wrapper">
        <span id="subject-display"></span>
      </div>

      <div class="video-box">
        <video id="preview" autoplay muted></video>
        <div class="video-text" id="video-text">
          Ici va s'enregistrer ton improvisation en vidéo. <br>
          Lorsque tu es prêt, clique sur le bouton "Démarrer ton impro".<br><br>
          NB : ta vidéo est stockée sur ton appareil. Aucun enregistrement n'est conservé par Letmotiv.
        </div>
        <div class="recording-indicator" id="recording-indicator">
          <span class="dot"></span> Enregistrement en cours
        </div>
        <div class="countdown" id="countdown">1:59</div>
        <div class="initial-countdown-overlay" id="initial-countdown-overlay">
          <div class="initial-countdown" id="initial-countdown">3</div>
        </div>
      </div>

      <div class="impro-actions">
        <button id="start-btn" aria-label="Démarrer l'impro">Démarrer ton impro <i class="fas fa-video"></i></button>
        <button id="stop-btn" class="hidden-btn" aria-label="Arrêter l'impro">Arrêter <i class="fas fa-stop"></i></button>
        <button id="restart-btn" class="hidden-btn" aria-label="Récommencer l'impro">Récommencer <i class="fas fa-redo"></i></button>
      </div>

      <div id="impro-error" class="error-message">
        Tu dois réaliser ton improvisation avant de continuer.
      </div>

      <!-- Flèche bas => box4 -->
      <button class="next-btn" id="next-btn2" disabled aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- BOX4 (3e étape) -->
    <div class="box" id="box4">
      <div class="box-header">
        <button class="back-btn" id="back-btn4" aria-label="Retour box2">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Partage ton expérience</div>
        <div class="step-indicator">3/4</div>
      </div>

      <p>
        Encourage d'autres personnes à relever le défi ! Montre ton courage et inspire-les à s'améliorer en improvisation.<br>
        <b>#ChallengeImproLetmotiv</b>
      </p>

      <a
        id="linkedin-share-button"
        href="https://www.linkedin.com/shareArticle?mini=true&url=https://letmotiv-simulateur.fr"
        target="_blank"
        rel="noopener noreferrer"
        class="linkedin-share-button"
        aria-label="Partager sur LinkedIn"
      >
        <i class="fab fa-linkedin"></i> Partager sur LinkedIn
      </a>

      <div class="progression-buttons">
        <p>Tu souhaites progresser rapidement en prise de parole ?</p>
        <a href="https://alexetpierre.systeme.io/inscription" target="_blank" rel="noopener noreferrer" class="btn">
          <i class="fas fa-laptop"></i> Suis notre formation en ligne
        </a>
        <a href="https://www.letmotiv.fr/offres-particulier/coaching-prise-de-parole" target="_blank" rel="noopener noreferrer" class="btn">
          <i class="fas fa-chalkboard-teacher"></i> Réserve un coaching
        </a>
      </div>

      <!-- Flèche bas => box3 -->
      <button class="next-btn" id="next-btn4" aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- BOX3 (4e étape) -->
    <div class="box" id="box3">
      <div class="box-header">
        <button class="back-btn" id="back-btn3" aria-label="Retour box4">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Analyse ta prestation</div>
        <div class="step-indicator">4/4</div>
      </div>

      <div class="download-section">
        <h3>Obtiens la vidéo de ta prestation et une grille Letmotiv :</h3>

        <div class="download-fields">
          <div class="input-group">
            <label for="prenom">Prénom :</label>
            <input type="text" id="prenom" placeholder="Votre prénom" aria-label="Prénom"/>
            <div id="prenom-error" class="error-message">
              Veuillez entrer un prénom valide sans chiffres ni caractères spéciaux.
            </div>
          </div>
          <div class="input-group">
            <label for="email">Email :</label>
            <input type="email" id="email" placeholder="Votre email" aria-label="Email"/>
            <div id="email-error" class="error-message">
              Veuillez entrer une adresse email valide.
            </div>
          </div>
        </div>

        <div>
          <button id="validate-form-btn" aria-label="Valider infos">Valider</button>
        </div>
      </div>

      <div class="download-buttons" id="download-buttons">
        <button id="download-video-btn">
          <i class="fas fa-download"></i> Télécharger la vidéo (mp4)
        </button>
        <button id="download-pdf-btn">
          <i class="fas fa-download"></i> Télécharger la grille d'évaluation (pdf)
        </button>
      </div>
    </div>
  </div><!-- /box-container -->

  <script>
    /*************************************
     * 1) Intro fadeOut
     *************************************/
    const introBox = document.getElementById('intro-box');
    const startIntroBtn = document.getElementById('start-intro-btn');
    const topProgressBar = document.getElementById('top-progress-bar');

    startIntroBtn.addEventListener('click', () => {
      introBox.style.animation = 'fadeOut 0.5s forwards';
      setTimeout(() => {
        introBox.style.display = 'none';
        // Passer direct à box1 (SANS animation)
        showBox(null, 1);
      }, 500);
    });

    function updateProgressBar(step) {
      const pct = step * 25; // 4 étapes => 25% par étape
      topProgressBar.style.width = pct + '%';
    }

    /*************************************
     * 2) Boîtes & navigation
     *************************************/
    const boxContainer = document.getElementById('box-container');
    const boxes = {
      1: document.getElementById('box1'),
      2: document.getElementById('box2'),
      3: document.getElementById('box4'), // 3e étape
      4: document.getElementById('box3')  // 4e étape
    };

    // On garde en mémoire la box actuellement visible
    let currentBox = null;

    function showBox(oldStep, newStep) {
      // Si on a une ancienne box, on lance l'anim de sortie
      if (oldStep && boxes[oldStep]) {
        boxes[oldStep].classList.remove('slide-in-down', 'active');
        boxes[oldStep].classList.add('slide-out-up'); 
        boxes[oldStep].addEventListener('animationend', function handleOldEnd() {
          boxes[oldStep].removeEventListener('animationend', handleOldEnd);
          boxes[oldStep].style.display = 'none';
          boxes[oldStep].classList.remove('slide-out-up');
        });
      }

      // Afficher la nouvelle box
      if (newStep && boxes[newStep]) {
        const newBox = boxes[newStep];
        // *** CAS SPÉCIAL BOX1 *** => Pas d'animation si on vient de l'intro
        if (oldStep === null || newStep === 1) {
          // Juste afficher la box1 sans anim
          newBox.style.display = 'flex'; // Utiliser flex pour le centrage vertical
          newBox.classList.add('active');
        } else {
          // Slide-in normal
          newBox.style.display = 'block';
          newBox.classList.add('slide-in-down');
          newBox.addEventListener('animationend', function handleNewEnd() {
            newBox.removeEventListener('animationend', handleNewEnd);
            newBox.classList.remove('slide-in-down');
            newBox.classList.add('active');
          });
        }
        currentBox = newStep;
        updateProgressBar(newStep);
      } else {
        currentBox = null;
      }
    }

    // Boutons "Suivant"
    const nextBtns = {
      1: document.getElementById('next-btn1'),
      2: document.getElementById('next-btn2'),
      3: document.getElementById('next-btn4')
    };
    // Boutons "Retour"
    const backBtns = {
      2: document.getElementById('back-btn2'),
      3: document.getElementById('back-btn4'),
      4: document.getElementById('back-btn3')
    };

    nextBtns[1].addEventListener('click', () => {
      // Vérifier objectif choisi
      const selected = document.querySelector('.objectives-container .selected-objective');
      if (!selected) {
        const err = document.getElementById('objective-error');
        err.style.display = 'block';
        err.textContent = "Sélectionne un objectif avant de continuer.";
        return;
      }
      showBox(1, 2);
    });

    nextBtns[2].addEventListener('click', () => {
      // Vérifier si l'impro est finalisée => nextBtns[2] est disabled jusqu’au stop
      if (nextBtns[2].disabled) {
        const improError = document.getElementById('impro-error');
        improError.textContent = "Tu dois réaliser ton improvisation avant de continuer.";
        improError.style.display = 'block';
        return;
      }
      showBox(2, 3);
    });
    nextBtns[3].addEventListener('click', () => {
      showBox(3, 4);
    });

    // Boutons "Retour"
    backBtns[2].addEventListener('click', () => {
      showBox(2, 1);
    });
    backBtns[3].addEventListener('click', () => {
      showBox(3, 2);
    });
    backBtns[4].addEventListener('click', () => {
      showBox(4, 3);
    });

    /*************************************
     * 3) Explications par catégorie
     *************************************/
    const explanations = {
      convaincre:   "Essaye de convaincre ton auditoire d’une idée générale.",
      inspirer:     "Tu as 2 minutes top chrono pour inspirer ton auditoire.",
      'lacher-prise': "Amuse-toi, libère-toi de tes freins et lâche prise.",
      toast:        "Porte un toast marquant pour célébrer un événement.",
      repartie:     "Réponds du tac-au-tac et montre ton sens de la répartie.",
      vendre:       "Fais un argumentaire de vente percutant.",
      conflit:      "Gère un désaccord ou une tension avec diplomatie.",
      diction:      "Améliore ta diction et rends ton discours plus clair."
    };
    const txtFilesByCategory = {
      convaincre:   "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/convaincre.txt",
      inspirer:     "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/inspirer.txt",
      'lacher-prise': "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/lacher_prise.txt",
      toast:        "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/toast.txt",
      repartie:     "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/repartie.txt",
      vendre:       "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/vendre.txt",
      conflit:      "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/gerer_un_conflit.txt",
      diction:      "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/diction.txt"
    };

    let subjectsCache = {
      convaincre: null,
      inspirer: null,
      'lacher-prise': null,
      toast: null,
      repartie: null,
      vendre: null,
      conflit: null,
      diction: null
    };

    const objectivesButtons = document.querySelectorAll('.objectives-container button');
    const explanationBox = document.getElementById('explanation-box');
    let currentCategory = null;

    objectivesButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        objectivesButtons.forEach(b => b.classList.remove('selected-objective'));
        btn.classList.add('selected-objective');

        currentCategory = btn.dataset.category;
        explanationBox.textContent = explanations[currentCategory] || "";
        explanationBox.classList.add('show');

        // Pré-charger le fichier .txt
        if (subjectsCache[currentCategory] === null) {
          await loadSubjects(currentCategory);
        }

        // Cacher erreurs
        document.getElementById('objective-error').style.display = 'none';
        document.getElementById('impro-error').style.display = 'none';
      });
    });

    async function loadSubjects(category) {
      const filePath = txtFilesByCategory[category];
      if (!filePath) return [];
      try {
        const res = await fetch(filePath);
        if (!res.ok) return [];
        const text = await res.text();
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        subjectsCache[category] = lines;
        return lines;
      } catch(e) {
        console.error("Erreur fetch", e);
        return [];
      }
    }

    /*************************************
     * 4) Sujet d'impro
     *************************************/
    const generateSubjectBtn = document.getElementById('generate-subject-btn');
    const subjectWrapper = document.getElementById('subject-wrapper');
    const subjectDisplay = document.getElementById('subject-display');
    let currentSubject = "";

    generateSubjectBtn.addEventListener('click', () => {
      if (!currentCategory) {
        const err = document.getElementById('objective-error');
        err.textContent = "Merci de sélectionner un objectif avant de générer un sujet.";
        err.style.display = 'block';
        return;
      }
      const arr = subjectsCache[currentCategory];
      if (!arr || arr.length === 0) {
        subjectDisplay.textContent = "Aucun sujet disponible pour le moment.";
        subjectWrapper.style.display = 'block';
        currentSubject = "";
        return;
      }
      const rand = Math.floor(Math.random() * arr.length);
      currentSubject = arr[rand];
      subjectDisplay.textContent = currentSubject;
      subjectWrapper.style.display = 'block';
      document.getElementById('impro-error').style.display = 'none';
    });

    /*************************************
     * 5) Enregistrement vidéo
     *************************************/
    let mediaRecorderInstance;
    let recordedChunks = [];
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const restartBtn = document.getElementById('restart-btn');
    const videoText = document.getElementById('video-text');
    const recordingIndicator = document.getElementById('recording-indicator');
    const countdownElement = document.getElementById('countdown');
    const initialCountdownOverlay = document.getElementById('initial-countdown-overlay');
    const initialCountdown = document.getElementById('initial-countdown');
    const improErrorDiv = document.getElementById('impro-error');

    let videoURL = "";
    let timerInterval;
    let timeRemaining = 120;

    startBtn.addEventListener('click', startImpro);
    stopBtn.addEventListener('click', stopImpro);
    restartBtn.addEventListener('click', restartImpro);

    function startImpro() {
      if (!currentSubject) {
        improErrorDiv.textContent = "Tu dois générer un sujet avant de démarrer l'impro.";
        improErrorDiv.style.display = 'block';
        return;
      }
      if (!navigator.mediaDevices?.getUserMedia || typeof MediaRecorder === 'undefined') {
        improErrorDiv.textContent = "L'enregistrement vidéo n'est pas supporté par ce navigateur.";
        improErrorDiv.style.display = 'block';
        return;
      }
      if (!confirm("Votre webcam va se lancer. Continuer ?")) {
        return;
      }
      startInitialCountdown();
    }

    function startInitialCountdown() {
      let count = 3;
      initialCountdown.textContent = count;
      initialCountdownOverlay.style.display = 'flex';

      const c = setInterval(() => {
        count--;
        if (count > 0) {
          initialCountdown.textContent = count;
        } else {
          clearInterval(c);
          initialCountdownOverlay.style.display = 'none';
          initiateRecording();
        }
      }, 1000);
    }

    async function initiateRecording() {
      const stream = await setupCamera();
      if (!stream) return;

      mediaRecorderInstance = new MediaRecorder(stream);
      recordedChunks = [];
      mediaRecorderInstance.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorderInstance.onstop = () => {
        const videoBlob = new Blob(recordedChunks, { type: 'video/mp4' });
        videoURL = URL.createObjectURL(videoBlob);
        stream.getTracks().forEach(t => t.stop());
        nextBtns[2].disabled = false; 
        videoText.textContent = "Improvisation terminée.";
        videoText.style.display = 'block';
        recordingIndicator.style.display = 'none';
        clearInterval(timerInterval);
      };

      mediaRecorderInstance.start();
      recordingIndicator.style.display = 'flex';
      videoText.style.display = 'none';
      startBtn.classList.add('hidden-btn');
      stopBtn.classList.remove('hidden-btn');
      stopBtn.disabled = false;
      restartBtn.classList.add('hidden-btn');
      nextBtns[2].disabled = true;
      startTimer();
    }

    async function setupCamera() {
      try {
        const st = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        preview.srcObject = st;
        return st;
      } catch(e) {
        improErrorDiv.textContent = "Impossible d'accéder à la webcam/micro. Vérifiez vos permissions.";
        improErrorDiv.style.display = 'block';
        console.error(e);
        return null;
      }
    }

    function startTimer() {
      timeRemaining = 120;
      updateCountdown();
      timerInterval = setInterval(() => {
        timeRemaining--;
        if (timeRemaining >= 0) {
          updateCountdown();
        } else {
          clearInterval(timerInterval);
          if (mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
            mediaRecorderInstance.stop();
            restartBtn.classList.remove('hidden-btn');
          }
        }
      }, 1000);
    }
    function updateCountdown() {
      const m = Math.floor(timeRemaining / 60);
      const s = timeRemaining % 60;
      countdownElement.textContent = `${m}:${s<10 ? '0'+s : s}`;
      countdownElement.style.display = 'block';
    }

    function stopImpro() {
      if (mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
        mediaRecorderInstance.stop();
        clearInterval(timerInterval);
        stopBtn.classList.add('hidden-btn');
        stopBtn.disabled = true;
        restartBtn.classList.remove('hidden-btn');
        recordingIndicator.style.display = 'none';
      }
    }

    function restartImpro() {
      restartBtn.classList.add('hidden-btn');
      videoText.innerHTML = "Ici va s'enregistrer ton improvisation en vidéo.<br>Lorsque tu es prêt, clique sur 'Démarrer ton impro'.<br><br>NB : vidéo stockée localement.";
      videoText.style.display = 'block';
      videoURL = "";
      startImpro();
    }

    /*************************************
     * 6) Formulaire Box3
     *************************************/
    const validateFormBtn = document.getElementById('validate-form-btn');
    const prenomInput = document.getElementById('prenom');
    const emailInput = document.getElementById('email');
    const downloadButtons = document.getElementById('download-buttons');
    const downloadVideoBtn = document.getElementById('download-video-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');

    validateFormBtn.addEventListener('click', () => {
      const prenomVal = prenomInput.value.trim();
      const emailVal = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const prenomRegex = /^[A-Za-zÀ-ÿ '-]+$/;

      document.getElementById('prenom-error').style.display = 'none';
      document.getElementById('email-error').style.display = 'none';

      let ok = true;
      if (!prenomVal || !prenomRegex.test(prenomVal)) {
        document.getElementById('prenom-error').style.display = 'block';
        ok = false;
      }
      if (!emailVal || !emailRegex.test(emailVal)) {
        document.getElementById('email-error').style.display = 'block';
        ok = false;
      }
      if (!ok) return;

      downloadButtons.classList.add('show');
    });

    downloadVideoBtn.addEventListener('click', () => {
      if (!videoURL) {
        alert("Aucune vidéo enregistrée.");
        return;
      }
      const link = document.createElement('a');
      link.href = videoURL;
      link.download = 'Letmotiv_Improvisation.mp4';
      document.body.appendChild(link);
      link.click();
      link.remove();
    });
    downloadPdfBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = "https://drive.google.com/uc?export=download&id=1pKif7hwkdSQRXLv6uoSQawCs3DIIcb70";
      link.download = "Questions_Evaluation.pdf";
      document.body.appendChild(link);
      link.click();
      link.remove();
    });
  </script>
</body>
</html>
